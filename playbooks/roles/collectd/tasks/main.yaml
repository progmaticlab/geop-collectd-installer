---

- name: install collectd
  package:
    name: collectd
    state: present

- name: install collectd-python
  package:
    name: collectd-utils
    state: present

- name: create collectd.conf
  template:
    src: collectd.j2
    dest: /etc/collectd/collectd.conf


- name: create /opt/collectd_plugins
  ansible.builtin.file:
    path: /opt/collectd_plugins
    state: directory
    mode: '0755'

- name: create /opt/collectd_plugins/dict
  ansible.builtin.file:
    path: /opt/collectd_plugins/dict
    state: directory
    mode: '0755'

- name: create disk_type_instance_data.json
  ansible.builtin.file:
    path: /opt/collectd_plugins/dict/disk_type_instance_data.json
    state: touch

- name: create disk_type_map.json
  copy:
    src: disk_type_map.json
    dest: /opt/collectd_plugins/dict/disk_type_map.json


- name: create vm_cpu plugin
  copy:
    src: vm_cpu.py
    dest: /opt/collectd_plugins/vm_cpu.py

- name: create vm_mem plugin
  copy:
    src: vm_mem.py
    dest: /opt/collectd_plugins/vm_mem.py

- name: create vm_disk plugin
  copy:
    src: vm_disk.py
    dest: /opt/collectd_plugins/vm_disk.py

- name: create ballast
  copy:
    src: ballast.py
    dest: /opt/collectd_plugins/ballast.py

- name: add types into types.db
  blockinfile:
    path: /usr/share/collectd/types.db
    block: "{{ lookup('file', 'types.db') }}"
    marker: "# ANSIBLE MANAGED BLOCK"

- name: collectd bug fix
  blockinfile:
    path: /etc/default/collectd
    insertafter: EOF
    block: 'LD_PRELOAD=/usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.so'

- name: restart collectd
  ansible.builtin.systemd:
    state: restarted
    daemon_reload: yes
    name: collectd

